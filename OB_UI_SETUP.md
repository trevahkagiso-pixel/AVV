OB UI — Setup, maintenance and quick reference

Purpose
- Describes how to run, build and maintain the Order Block (OB) UI and the Ichimoku UI in this repository.
- Records common pain points (missing DB tables / 1h data) and how to resolve them.

Repository layout (key files)
- `ob_ui.py` — Flask app implementing the OB dashboard and pair detail pages.
- `web_ui.py` — Flask app implementing the Ichimoku UI.
- `ob_refined_strategy.py` — OB backtest engine and helpers used by `ob_ui.py`.
- `ichimoku_backtest.py` — Backtest functions used by `web_ui.py`.
- `ob_backtest_summary.csv` — Cached summary produced by `python ob_ui.py --build` and consumed by the OB dashboard.
- Chart HTML files (generated by the apps and Plotly):
  - OB: `{pair}_ob_clean.html`, `{pair}_ob_trades.html`, `{pair}_ob_equity.html`
  - Ichimoku: `{pair}_clean.html`, `{pair}_ichimoku.html`, `{pair}_equity.html`
- `forex.db`, `stocks.db`, `commodities.db` — SQLite DBs containing OHLC tables for pairs. Table names must match the pair naming convention (e.g. `EUR_USD_daily`).

Pair lists and classification
- `ob_ui.py` contains three lists near the top of the file:
  - `FOREX_PAIRS`, `STOCK_PAIRS`, `COMMODITY_PAIRS`
  - `ALL_PAIRS = FOREX_PAIRS + STOCK_PAIRS + COMMODITY_PAIRS`
- If you add/remove CSVs or DB tables, update these lists so the dashboard and builder include/exclude the pair.

Common issue: "Table 'XXX' does not exist"
- When running the OB cache builder, you may see errors like:
  "Table 'EURUSD_1h' does not exist in sqlite:///forex.db. Available tables: [...]"
- This is because the builder attempted to run backtests for a pair (often a 1h variant) that does not exist in the DB.
- Fixes:
  - Easiest: remove the non-existent pair name from `FOREX_PAIRS` (or other lists) in `ob_ui.py` and re-run `--build`.
  - Alternatively: ingest 1h data into the appropriate DB with the exact table name expected.

How to rebuild the OB cache (recommended workflow)
- Stop any running servers (optional but recommended when changing code):

```bash
pkill -f web_ui.py || true
pkill -f ob_ui.py || true
```

- Run the cache builder (this iterates `ALL_PAIRS` and executes backtests, then writes `ob_backtest_summary.csv`):

```bash
python3 ob_ui.py --build
# Output will show per-pair backtest progress and save the summary CSV
```

- After a successful build, start the UIs:

```bash
nohup python3 web_ui.py --port 5000 &> ichimoku_ui.log &
nohup python3 ob_ui.py --port 5001 &> ob_ui.log &
# then tail logs to confirm
tail -n 120 ichimoku_ui.log ob_ui.log
```

How to run only the web server (no build)

```bash
python3 ob_ui.py --port 5001
# or
python3 web_ui.py --port 5000
```

Naming conventions & chart metadata
- Charts are saved to the repository root with names described above. The UI uses their filenames to generate `iframe` cards.
- The UI also shows per-chart metadata (file size and last-modified timestamp) — this is computed server-side from the chart file on disk.

Key UI behaviors to be aware of
- Dark mode: toggled in the UI and persisted in `localStorage`.
- Lazy-loading thumbnails: the detail view `Plots` tab uses `data-src` on `iframe` elements and sets `src` only when the tab/modal is opened — this reduces startup memory and network usage.
- Modal expansion: clicking a chart sets the modal iframe `src` to the corresponding chart file and opens the modal.

How to add 1h (or new timeframe) data
- Insert the OHLC table into the appropriate DB (e.g., `forex.db`) with the exact table name expected by the pair lists (e.g. `EURUSD_1h` or `EUR_USD_1h` depending on naming used in the lists).
- Verify the table exists using sqlite3 or a small Python snippet:

```bash
sqlite3 forex.db ".tables" | grep EUR
# or in Python
python -c "import sqlite3; print(__import__('sqlite3').connect('forex.db').cursor().execute('SELECT name FROM sqlite_master WHERE type=\"table\"').fetchall())"
```

- Re-run `python3 ob_ui.py --build` to include the new timeframe in the cache.

Troubleshooting tips
- If the builder fails for a pair, the printed error usually tells you which table is missing.
- If Flask reloads repeatedly after an edit, check the file for syntax warnings (e.g., unescaped backslashes in triple-quoted strings). Use `r"""..."""` if embedding JS/regex with backslashes.
- Use `ss -ltnp | grep -E ':5000|:5001'` to check whether the servers are listening.

Contact/Next steps
- If you'd like, I can:
  - Add an ingestion script to convert CSVs into DB tables (for adding 1h data).
  - Make the pair lists external (e.g., move to a `pairs.json`) so they are easier to maintain.
  - Add a small health-check endpoint that returns last cache build time and per-pair availability.

-- End of document
